# Development Dockerfile bundling the Next.js app and realtime server
FROM node:20-alpine

ARG NODE_ENV=development

ENV PNPM_HOME=/root/.local/share/pnpm \
    PATH=/root/.local/share/pnpm:$PATH \
    NEXT_TELEMETRY_DISABLED=1 \
    NODE_ENV=${NODE_ENV} \
    PORT=3000 \
    APP_SERVER_PORT=3001 \
    REALTIME_BASE_PATH=/realtime \
    NEXT_PUBLIC_REALTIME_URL=/realtime \
    NEXT_PUBLIC_REALTIME_PATH=/realtime/socket.io \
    REALTIME_SERVER_EVENT_PATH=/realtime/events \
    TURBOPACK=1

RUN apk add --no-cache openssl \
    && corepack enable

WORKDIR /app

# Install deps first (better caching)
COPY package.json pnpm-lock.yaml ./
RUN SKIP_PRISMA_POSTINSTALL=1 PRISMA_SKIP_POSTINSTALL_GENERATE=1 pnpm install --no-frozen-lockfile

# Copy the rest
COPY . .

# Generate Prisma client now that schema exists
RUN pnpm prisma:generate

EXPOSE 3000

CMD ["sh", "-c", "pnpm -s prisma:generate && node scripts/run-prisma-migrate.mjs && (pnpm -s db:seed || true) && node scripts/start-with-proxy.mjs"]
